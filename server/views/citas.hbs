<section>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <div class="d-flex flex-column min-vh-100">
    <header class="sticky-top bg-white border-bottom">
      <nav aria-label="breadcrumb" class="container">
        <ol class="breadcrumb my-2">
          <li class="breadcrumb-item"><a href="/index">Inicio</a></li>
          <li class="breadcrumb-item active" aria-current="page">Reservar una Cita</li>
        </ol>
      </nav>
    </header>
    <main class="flex-grow-1 container my-4">
      <div class="row g-4">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="container my-4">
              <div class="text-center">
                <h1 class="h4 font-weight-bold">Reservar una Cita</h1>
                <p class="text-muted">Complete el formulario a continuación para programar su cita.</p>
              </div>
              <form id="form" class="row g-3" action="/citas" method="POST">
                <div class="col-md-6">
                  <label for="nombre_cliente" class="form-label">Nombre del cliente</label>
                  <input type="text" class="form-control" id="nombre_cliente" name="nombre_cliente"
                    placeholder="Ingrese el nombre del cliente">
                </div>
                <div class="col-md-6">
                  <label for="id_empleado" class="form-label">Empleado</label>
                  <select class="form-control" id="id_empleado" name="id_empleado">
                    {{#each barberos}}
                    <option value={{id}}>{{nombre}}</option>
                    {{/each}}
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="fecha_cita" class="form-label">Fecha de la Cita</label>
                  <input type="datetime-local" class="form-control" id="fecha_cita" name="fecha_cita">
                </div>
                <div class="col-md-6">
                  <label for="estado" class="form-label">Cita para:</label>
                  <select class="form-control" id="semanas" name="semanas">
                    <option value="">Seleccione</option>
                    <option value="7">Próxima semana</option>
                    <option value="15">15 días</option>
                    <option value="21">21 días</option>
                  </select>
                </div>

                <div class="col-md-6" id="direccion_seccion" style="display: none;">
                  <div>
                    <label for="calle" class="form-label">Calle</label>
                    <input type="text" class="form-control" id="id_calle" name="calle" placeholder="Ingrese la calle">
                  </div>
                  <div>
                    <label for="sector" id="id_servicio" class="form-label">Sector</label>
                    <input type="text" class="form-control" id="id_sector" name="sector"
                      placeholder="Ingrese el sector">
                  </div>
                  <div>
                    <label for="id_provincia" class="form-label">Provincia</label>
     
                    <select class="form-control" name="provincia" id="id_provincia" data-id={{id}}>
 
                      {{#each provincias}}
                      <option value={{id}}>{{provincia}}</option>
                      {{/each}}
                    </select>
                  </div>
                  <div>
                    <label for="id_municipio" class="form-label">Municipio</label>
                    <select class="form-control" name="municipio" id="id_municipio">
                      {{#each municipios}}
                      <option value={{id}} data-provincia={{id_provincia}}>{{municipio}}</option>
                      {{/each}}
                    </select>
                  </div>
                </div>

                <div class="col-md-6">
                  <label for="estado" class="form-label">Local/A Domicilio</label>
                  <select class="form-control" id="estado" onchange="toggleDireccion()">
                    <option value="1">Local</option>
                    <option value="0">A domicilio</option>
                  </select>
                </div>

                <div class="col-md-6 mb-2">
                  <label for="comentario" class="form-label">Comentario</label>
                  <textarea class="form-control" id="comentario" name="comentario" rows="3"
                    placeholder="Ingrese un comentario"></textarea>
                </div>

                <table class="table table-bordered">
                  <thead>
                    <tr>
                      <th>Servicio</th>
                      <th>Precio</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="detalles-list">
                    <!-- Aquí se insertarán los detalles dinámicamente -->
                  </tbody>
                </table>
                <div class="text-right ml-2 mb-3">
                  <strong>Total de los servicios: $<span id="total-factura">0.00</span></strong>
                </div>
                <div class="col-12 d-flex justify-content-center" style="margin-top: 20px;">
                  <button type="button" class="btn btn-secondary m-3" onclick="agregarDetalle()">Agregar Servicios</button>
                </div>
                <div class="col-12 d-flex justify-content-end" style="margin-top: 20px;">
                  <button type="submit" class="btn btn-primary m-4">Reservar</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</section>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
  function toggleDireccion() {
    let estado = document.getElementById('estado').value;
    let direccionSeccion = document.getElementById('direccion_seccion');
    direccionSeccion.style.display = (estado == '0') ? 'block' : 'none';
  }

  function limpiarFormulario() {
    $('#form')[0].reset();
    $('#detalles-list').empty();
    $('#total-factura').text('0.00');
  }

  function agregarDetalle() {
    let nuevoDetalle = `
    <tr>
        <td>
            <select class="form-control id-producto-servicio" name="id_servicio" onchange="actualizarPrecio(this)" required>
                <option value="" disabled selected>Seleccione un servicio</option>
                {{#each servicios}}
                    <option value={{id}} data-precio={{precio}}>{{this.servicios}}</option>
                {{/each}}
            </select>
        </td>
        <td><input type="number" class="form-control precio-unitario" name="precio_unitario" readonly></td>
        <td><button type="button" class="btn btn-danger" onclick="eliminarDetalle(this)">Eliminar</button></td>
    </tr>`;
    
    $('#detalles-list').append(nuevoDetalle);
    actualizarTotalFactura();

    $('html, body').animate({
        scrollTop: $('#detalles-list').offset().top + $('#detalles-list').height()
    }, 500);
  }

  function actualizarPrecio(select) {
    let precio = $(select).find(':selected').data('precio');
    let row = $(select).closest('tr');
    row.find('.precio-unitario').val(precio);
    actualizarTotalFactura();
  }

  function eliminarDetalle(button) {
    $(button).closest('tr').remove();
    actualizarTotalFactura();
  }

  function actualizarTotalFactura() {
    let total = 0;
    $('#detalles-list .precio-unitario').each(function () {
      total += parseFloat($(this).val()) || 0;
    });
    $('#total-factura').text(total.toFixed(2));
  }

  $(document).ready(function () {
    $('#id_provincia').on('change', function () {
      var selectedProvince = $(this).val();
      $('#id_municipio option').each(function () {
        var municipioProvincia = $(this).data('provincia');
        $(this).toggle(municipioProvincia == selectedProvince);
      });
      $('#id_municipio').val('');
    });

    $('#id_provincia').trigger('change');

    $('#form').on('submit', function (e) {
      // e.preventDefault(); // Evitar envío tradicional si estás haciendo una solicitud AJAX

      let formData = $(this).serializeArray();
      let data = {};
      $(formData).each(function (i, field) {
        data[field.name] = field.value;
      });

      let detalles = [];
      $('#detalles-list tr').each(function () {
        let id_servicio = $(this).find('.id-producto-servicio').val();
        if (id_servicio) {
          detalles.push({
            id_servicio: id_servicio
          });
        }
      });

      if (detalles.length === 0) {
        alert('Debes agregar al menos un detalle a la cita.');
        return false; // Cancelar el envío si no hay detalles
      }

      data['detalles'] = detalles;

      $.ajax({
        url: '/citas',
        type: 'POST',
        data: JSON.stringify(data),
        contentType: 'application/json',
        success: function (response) {
          Swal.fire({
            icon: 'success',
            title: 'Cita reservada',
            text: 'La cita ha sido reservada con éxito.',
          }).then(() => {
            window.location.href = '/index';
          });
        },
        error: function (xhr, status, error) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Hubo un problema al reservar la cita. Por favor, inténtelo de nuevo.',
          });
          console.error('Error:', error);
        }
      });

      return false; // Evitar el envío tradicional del formulario
    });
  });

function sumarDias(fecha, dias) {
  const nuevaFecha = new Date(fecha);
  nuevaFecha.setDate(nuevaFecha.getDate() + dias);
  
  // Formatear la fecha para el campo datetime-local
  const anio = nuevaFecha.getFullYear();
  const mes = String(nuevaFecha.getMonth() + 1).padStart(2, '0'); // Meses en JavaScript van de 0 a 11
  const dia = String(nuevaFecha.getDate()).padStart(2, '0');
  const hora = String(nuevaFecha.getHours()).padStart(2, '0');
  const minuto = String(nuevaFecha.getMinutes()).padStart(2, '0');
  
  return `${anio}-${mes}-${dia}T${hora}:${minuto}`;
}

  const fechaCita = document.getElementById('fecha_cita');
const semanas = document.getElementById('semanas');

semanas.addEventListener('change', function() {
  if (semanas.value) {
    const dias = parseInt(semanas.value, 10);
    const fechaSeleccionada = Date.now();

    if (fechaSeleccionada) {
      const nuevaFecha = sumarDias(fechaSeleccionada, dias);
      fechaCita.value = nuevaFecha; // Actualizar el campo fecha_cita con la nueva fecha
    }

  } 
});


</script>
