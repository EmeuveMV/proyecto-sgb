<title>Facturación</title>
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<style>
    #formulario-factura {
        display: none;
    }

    #formulario-factura.mostrar {
        display: block;
    }

    #lista-facturas.ocultar {
        display: none;
    }
</style>

<div class="container">
    <header class="sticky-top bg-white border-bottom">
        <nav aria-label="breadcrumb" class="container">
            <ol class="breadcrumb my-2">
                <li class="breadcrumb-item"><a href="/index">Inicio</a></li>
                <li class="breadcrumb-item active" aria-current="page">Facturar</li>
            </ol>
        </nav>
    </header>
    <br>
    <div id="lista-facturas">
        <h1 class="mb-4">Lista de Facturas</h1>
        <div class="mb-3">
            <input type="text" id="search" class="form-control" placeholder="Buscar factura...">
        </div>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>ID Factura</th>
                    <th>ID Cliente</th>
                    <th>Fecha</th>
                    <th>Total</th>
                    <th>Método de Pago</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="facturas-list">
                {{#each facturas}}
                <tr>
                    <td>{{this.id_factura}}</td>
                    <td>{{this.id_cliente}}</td>
                    <td>{{this.fecha_factura}}</td>
                    <td>{{this.total}}</td>
                    <td>{{this.metodo_pago}}</td>
                    <td>{{this.estado}}</td>
                    <td>
                        <!-- Acciones -->
                    </td>
                </tr>
                {{/each}}
            </tbody>
        </table>
        <button class="btn btn-primary" onclick="toggleFormulario()">Agregar Factura</button>
    </div>

    <div id="formulario-factura">
        <h1 class="mb-4">Facturar</h1>
        <form id="factura-form" action="/facturacion" method="POST">
            <div class="form-group">
                <label for="nombre_cliente">Nombre del cliente</label>
                <input type="text" class="form-control" id="nombre_cliente" name="nombre_cliente" required>
            </div>
            <div class="form-group">
                <label for="metodoPago">Método de Pago</label>
                <select class="form-control" id="metodoPago" name="id_metodo_pago" required>
                    <option value="1">Efectivo</option>
                    <option value="2">Tarjeta</option>
                    <option value="3">Transferencia</option>
                </select>
            </div>
            <div class="form-group">
                <label for="id_empleado" class="form-label">Empleado</label>
                <select class="form-control" id="id_empleado" name="id_empleado">
                    {{#each empleados}}
                    <option value={{id}}>{{nombre}}</option>
                    {{/each}}
                </select>
            </div>
            <input type="hidden" name="total" id="total" value="0"> <!-- Campo oculto para el total -->
            <br>
            <h2>Detalles de Factura</h2>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>ID Producto/Servicio</th>
                        <th>Cantidad</th>
                        <th>Precio Unitario</th>
                        <th>Subtotal</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="detalles-list">
                    <!-- Aquí se insertarán los detalles dinámicamente -->
                </tbody>
            </table>
            <div class="text-right mb-3">
                <strong>Total Factura: $<span id="total-factura">0.00</span></strong>
            </div>
            <button type="button" class="btn btn-secondary" onclick="agregarDetalle()">Agregar Detalle</button>
            <button type="submit" class="btn btn-primary">Guardar Factura</button>
            <button type="button" class="btn btn-secondary" onclick="toggleFormulario()">Cancelar</button>
        </form>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
    function toggleFormulario() {
        $('#lista-facturas').toggleClass('ocultar');
        $('#formulario-factura').toggleClass('mostrar');
        limpiarFormulario();
    }

    function limpiarFormulario() {
        $('#factura-form')[0].reset();
        $('#detalles-list').empty();
        $('#total-factura').text('0.00');
    }

    function agregarDetalle() {
        let nuevoDetalle = `
    <tr>
        <td>
        <input type="hidden" name="detalles" id="detalles">
            <select class="form-control id-producto-servicio" name="id_servicio" onchange="actualizarPrecio(this)" required>
                <option value="" disabled selected>Seleccione un producto</option>
                {{#each servicios}}
                    <option value="{{id}}" data-precio="{{precio}}">{{this.servicios}}</option>
                {{/each}}
            </select>
        </td>
        <td><input type="number" class="form-control cantidad" name="cantidad" value="1" required></td>
        <td><input type="number" class="form-control precio-unitario" name="precio_unitario" readonly></td>
        <td><input type="number" class="form-control subtotal" name="subtotal" readonly></td>
        <td><button type="button" class="btn btn-danger" onclick="eliminarDetalle(this)">Eliminar</button></td>
    </tr>`;
        $('#detalles-list').append(nuevoDetalle);
    }

    function actualizarPrecio(select) {
        let precio = $(select).find(':selected').data('precio');
        let row = $(select).closest('tr');
        row.find('.precio-unitario').val(precio);
        let cantidad = parseFloat(row.find('.cantidad').val()) || 1;
        let subtotal = cantidad * precio;
        row.find('.subtotal').val(subtotal.toFixed(2));
        actualizarTotalFactura();
    }

    function eliminarDetalle(button) {
        $(button).closest('tr').remove();
        actualizarTotalFactura();
    }

    function actualizarSubtotales() {
        $('#detalles-list').on('input', '.cantidad', function () {
            let row = $(this).closest('tr');
            let cantidad = parseFloat(row.find('.cantidad').val()) || 0;
            let precioUnitario = parseFloat(row.find('.precio-unitario').val()) || 0;
            let subtotal = cantidad * precioUnitario;
            row.find('.subtotal').val(subtotal.toFixed(2));
            actualizarTotalFactura();
        });
    }


$('#factura-form').on('submit', function(e) {
    e.preventDefault(); // Evita el envío automático del formulario

    // Construir el objeto de detalles de la factura
    let detalles = [];
    $('#detalles-list tr').each(function() {
        const id_servicio = $(this).find('.id-producto-servicio').val();
        const cantidad = $(this).find('.cantidad').val();
        const precio_unitario = $(this).find('.precio-unitario').val();
        const subtotal = $(this).find('.subtotal').val();

   

        if (id_servicio && cantidad && precio_unitario && subtotal) {
            detalles.push({
                id_servicio: id_servicio,
                cantidad: cantidad,
                precio_unitario: precio_unitario,
                subtotal: subtotal
            });
        }
    });

    
    if (detalles.length === 0) {
        alert('Debes agregar al menos un detalle a la factura.');
        return;
    }

    // Enviar los datos a través de AJAX
    $.ajax({
        type: 'POST',
        url: '/facturacion',
        data: {
            id_empleado: $('#id_empleado').val(),
            nombre_cliente: $('#nombre_cliente').val(),
            id_metodo_pago: $('#metodoPago').val(),
            total: $('#total').val(),
            detalles: detalles // Enviar directamente como array
        },
        success: function(response) {
            alert('Factura registrada con éxito');
            // Opcional: Redirigir o limpiar el formulario
        },
        error: function(error) {
            alert('Error al registrar la factura: ' + error.responseText);
        }
    });
});

    function actualizarTotalFactura() {
        let total = 0;
        $('#detalles-list .subtotal').each(function () {
            total += parseFloat($(this).val()) || 0;
        });
        $('#total-factura').text(total.toFixed(2));
        $('#total').val(total.toFixed(2));
    }

    $(document).ready(function () {
        actualizarSubtotales();  // <-- Asegúrate de que esto esté presente
    });

</script>